name: Enforce PyArrow Exclusion

on:
  push:
    paths:
      - pyproject.toml
      - .github/workflows/enforce-pyarrow-exclusion.yml
  pull_request:
    paths:
      - pyproject.toml

jobs:
  check-pyarrow:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Remove pyarrow dependency if present
        shell: bash
        run: |
          if ! grep -qi '"pyarrow' pyproject.toml; then
            echo "pyarrow dependency not found."
            exit 0
          fi

          tmp_file="$(mktemp)"
          if ! grep -vi '"pyarrow' pyproject.toml > "${tmp_file}"; then
            echo "::error::Failed to filter pyproject.toml"
            rm -f "${tmp_file}"
            exit 1
          fi

          mv "${tmp_file}" pyproject.toml
          echo "Removed pyarrow entry from pyproject.toml"

      - name: Fail if pyproject.toml was modified
        shell: bash
        run: |
          if git diff --quiet; then
              echo "pyproject.toml does not list pyarrow."
          else
              echo "::error::pyarrow dependency found and removed. Please drop it from pyproject.toml and recommit."
              git --no-pager diff
              exit 1

