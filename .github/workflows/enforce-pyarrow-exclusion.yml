name: Enforce PyArrow Exclusion

on:
  push:
    paths:
      - pyproject.toml
      - .github/workflows/enforce-pyarrow-exclusion.yml
  pull_request:
    paths:
      - pyproject.toml

jobs:
  check-pyarrow:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Remove pyarrow dependency if present
        shell: bash
        run: |
          python -c "from pathlib import Path; import sys; path = Path('pyproject.toml'); text = path.read_text(); target = '\"pyarrow'; \
if target not in text: sys.exit(0); lines = text.splitlines(); ends_with_newline = text.endswith('\n'); filtered_lines = [line for line in lines if target not in line]; \
path.write_text('\n'.join(filtered_lines) + ('\n' if ends_with_newline else '')); print('Removed pyarrow entry from pyproject.toml')"

      - name: Fail if pyproject.toml was modified
        shell: bash
        run: |
          if git diff --quiet; then
              echo "pyproject.toml does not list pyarrow."
          else
              echo "::error::pyarrow dependency found and removed. Please drop it from pyproject.toml and recommit."
              git --no-pager diff
              exit 1

